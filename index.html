<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title> Quick file sharing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      background: #000;
      color: #00ff99;
      font-family: "Share Tech Mono", monospace;
      padding: 20px;
    }
    .box {
      max-width: 600px;
      margin: auto;
      border: 1px solid #00ff99;
      padding: 18px;
      border-radius: 10px;
      background: rgba(0, 40, 0, 0.4);
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #002a00;
      border: 1px solid #00ff99;
      padding: 6px 12px;
      border-radius: 999px;
      margin-bottom: 14px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .connecting { background: yellow; }
    .online { background: #00ff99; box-shadow: 0 0 10px #00ff99; }
    .offline { background: red; }

    .file-item {
      border: 1px solid #006600;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .file-actions {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .btn-download {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 999px;
      background: linear-gradient(135deg, #00ff99, #00cc66);
      color: #001a00 !important;
      font-weight: bold;
      text-decoration: none;
      border: 1px solid #00ff99;
      box-shadow: 0 0 8px rgba(0, 255, 153, 0.5);
    }

    .btn-download:hover {
      filter: brightness(1.2);
    }

    .btn-delete {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #ff4d4d;
      background: #330000;
      color: #ffb3b3;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .btn-delete:hover {
      filter: brightness(1.1);
    }

    button {
      padding: 8px 18px;
      background: #00ff99;
      color: #001a00;
      font-weight: bold;
      border-radius: 999px;
      border: 0;
      cursor: pointer;
    }
    button:hover { filter: brightness(1.2); }

    /* Upload progress UI */
    .upload-progress {
      margin-top: 8px;
      font-size: 0.8rem;
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #001a00;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 4px;
      border: 1px solid #00ff99;
    }
    #progressFill {
      height: 100%;
      width: 0%;
      background: #00ff99;
      box-shadow: 0 0 10px #00ff99;
      transition: width 0.1s linear;
    }
  </style>
</head>
<body>
  <div class="box">
    <h2> quick file sharing</h2>
    <p>Note - Uploaded files will be automatically deleted after 5 minutes.</p>

    <div id="serverStatus" class="status-pill">
      <div id="serverDot" class="dot connecting"></div>
      <span id="serverText">Connecting to serverâ€¦</span>
    </div>

    <!-- Upload Section -->
    <input type="file" id="fileInput" multiple />
    <br /><br />
    <button id="uploadBtn">Upload Files</button>
    <p id="uploadStatus"></p>

    <!-- LIVE UPLOAD PROGRESS (default: hidden) -->
    <div class="upload-progress" id="uploadProgress" style="display:none;">
      <span id="progressText"></span>
      <div class="progress-bar">
        <div id="progressFill"></div>
      </div>
    </div>

    <h3 style="margin-top:18px;">Active Files:</h3>
    <div id="fileList"></div>
  </div>

  <!-- Footer -->
  <p style="
    text-align:center;
    margin-top:25px;
    color:#00ffcc;
    font-size:1rem;
    text-shadow:0 0 8px #00ff99;">
     Powered by <b>BAPON BARMON</b> 
  </p>

<script>
  // â† yahi tumhara Render backend URL hai
  const API_BASE = "https://file-transfer-backend-ifcf.onrender.com";

  const serverDot = document.getElementById("serverDot");
  const serverText = document.getElementById("serverText");
  const uploadBtn = document.getElementById("uploadBtn");
  const uploadStatus = document.getElementById("uploadStatus");
  const fileList = document.getElementById("fileList");
  const progressText = document.getElementById("progressText");
  const progressFill = document.getElementById("progressFill");
  const uploadProgressBox = document.getElementById("uploadProgress");

  let filesState = [];

  function setServerStatus(mode) {
    serverDot.classList.remove("connecting", "online", "offline");
    if (mode === "connecting") {
      serverDot.classList.add("connecting");
      serverText.textContent = "Connecting to serverâ€¦";
    } else if (mode === "online") {
      serverDot.classList.add("online");
      serverText.textContent = "Server Connected";
    } else {
      serverDot.classList.add("offline");
      serverText.textContent = "Server Offline / Sleeping";
    }
  }

  async function checkServer() {
    setServerStatus("connecting");
    try {
      const res = await fetch(API_BASE + "/", { method: "GET" });
      if (!res.ok) throw 0;
      setServerStatus("online");
    } catch {
      setServerStatus("offline");
    }
  }

  // Upload multiple files (max 10 MB each) with live progress (XHR)
  async function uploadFiles() {
    const input = document.getElementById("fileInput");
    const files = input.files;
    if (!files.length) {
      alert(" First upload any file.");
      return;
    }

    // 10 MB limit
    for (let f of files) {
      if (f.size > 10 * 1024 * 1024) {
        alert("File " + f.name + "You can upload up to 10 MB");
        return;
      }
    }

    const formData = new FormData();
    [...files].forEach(f => formData.append("files", f));

    uploadStatus.textContent = "Uploading...";
    uploadBtn.disabled = true;

    // Progress UI show & reset
    uploadProgressBox.style.display = "block";
    progressFill.style.width = "0%";
    progressText.textContent = "Uploading: 0%";

    // XMLHttpRequest for progress
    const xhr = new XMLHttpRequest();
    xhr.open("POST", API_BASE + "/upload", true);

    xhr.upload.onprogress = function (event) {
      if (event.lengthComputable) {
        const percent = Math.round((event.loaded * 100) / event.total);
        progressFill.style.width = percent + "%";
        progressText.textContent = "Uploading: " + percent + "%";
      }
    };

    xhr.onload = function () {
      uploadBtn.disabled = false;

      if (xhr.status >= 200 && xhr.status < 300) {
        uploadStatus.textContent = "Upload successful!";
        input.value = "";
        progressText.textContent = "Upload complete.";

        try {
          loadFiles();
          setServerStatus("online");
        } catch {}

        // Thodi der baad progress UI hide
        setTimeout(() => {
          uploadProgressBox.style.display = "none";
          progressFill.style.width = "0%";
          progressText.textContent = "";
        }, 1500);
      } else {
        uploadStatus.textContent = "Upload failed. Server or network issue.";
        setServerStatus("offline");
        progressText.textContent = "Upload failed.";
        progressFill.style.width = "0%";
        setTimeout(() => {
          uploadProgressBox.style.display = "none";
          progressText.textContent = "";
        }, 1500);
      }
    };

    xhr.onerror = function () {
      uploadBtn.disabled = false;
      uploadStatus.textContent = "Upload failed. Network error.";
      setServerStatus("offline");
      progressText.textContent = "Upload failed.";
      progressFill.style.width = "0%";
      setTimeout(() => {
        uploadProgressBox.style.display = "none";
        progressText.textContent = "";
      }, 1500);
    };

    xhr.send(formData);
  }

  async function loadFiles() {
    try {
      const res = await fetch(API_BASE + "/files");
      if (!res.ok) throw 0;

      setServerStatus("online");

      const data = await res.json();
      filesState = data.files.map(f => ({
        ...f,
        clientStart: Date.now()
      }));

      renderFiles();
    } catch {
      setServerStatus("offline");
    }
  }

  function renderFiles() {
    fileList.innerHTML = "";

    if (!filesState.length) {
      fileList.innerHTML = "<p>No active file available for Download.</p>";
      return;
    }

    filesState.forEach(f => {
      const msLeft = f.remainingMs - (Date.now() - f.clientStart);
      const sec = Math.max(0, Math.floor(msLeft / 1000));
      const timer = `${Math.floor(sec / 60)}:${String(sec % 60).padStart(2, "0")}`;

      const div = document.createElement("div");
      div.className = "file-item";
      div.innerHTML = `
        <b>${f.originalName}</b><br>
        Expires in: ${timer}<br><br>
        <div class="file-actions">
          <a class="btn-download" href="${API_BASE}/download/${f.id}" target="_blank">
            â¬‡ Download
          </a>
          <button class="btn-delete" onclick="deleteFileNow('${f.id}')">
            ðŸ—‘ Delete
          </button>
        </div>
      `;
      fileList.appendChild(div);
    });
  }

  // Manual delete button handler
  async function deleteFileNow(id) {
    const sure = confirm(" Are you want delete this file ?");
    if (!sure) return;

    try {
      const res = await fetch(API_BASE + "/files/" + id, {
        method: "DELETE"
      });
      if (!res.ok) throw 0;
      await loadFiles();
    } catch {
      alert("Delete fail. Server offline or network issue.");
    }
  }

  uploadBtn.addEventListener("click", uploadFiles);

  setInterval(renderFiles, 1000);  // timer update
  setInterval(loadFiles, 5000);    // server se fresh list

  checkServer();
  loadFiles();
</script>
</body>
</html>
